<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PerfectRed</title>
  <link rel="stylesheet" href="/styles.css?v=<%= version %>">
  <link rel="icon" href="data:image/png;base64,<%= faviconBase64 %>" type="image/png">
  <style>
    .breadcrumb a {
      color: rgb(255, 0, 0);
      text-decoration: none;
    }
    .breadcrumb a:hover {
      text-decoration: underline;
    }
    .breadcrumb span {
      color: #888;
      margin: 0 8px;
    }
    .breadcrumb .current-folder {
      color: #ff0000;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="version-id" id="version"></div>
  <script>
    fetch("/version")
      .then(res => res.json())
      .then(data => {
        document.getElementById("version").textContent = "v" + data.version;
      });
  </script>
  <nav>
      <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/library">Library</a></li>
      <li><a href="/statistics">Statistics</a></li>
      <li><a href="/webscrape">MangaDex</a></li>
      <li><a href="/settings">Settings</a></li>
      </ul>
  </nav>

  <div class="container">
    <% 
      // Get the current folder name for display
      var currentFolderName = '';
      if (breadcrumbs.length > 0) {
        currentFolderName = breadcrumbs[breadcrumbs.length - 1].name;
      }
    %>
    
    <center><h1 style="margin-top: 30px; margin-bottom: 30px;">
      <%= currentFolderName || 'Library' %>
    </h1></center>
    
    <div class="breadcrumb">
      <a href="/library" style="margin-left: 10px;">Home</a>
      <% if (breadcrumbs.length > 0) { %>
        <% breadcrumbs.forEach((crumb, index) => { %>
          <span>‚Ä∫</span>
          <% if (index === breadcrumbs.length - 1) { %>
            <span class="current-folder"><%= crumb.name %></span>
          <% } else { %>
            <a href="/library?folder=<%= encodeURIComponent(crumb.path) %>"><%= crumb.name %></a>
          <% } %>
        <% }) %>
      <% } %>
    </div>

    <!-- Manga Section -->
    <% if (mangaFolders.length > 0) { %>
      <div class="folders-section" style="margin-left: 15px;">
        <h2 style="padding-top: 5px; padding-bottom: 5px;">Manga</h2>
        <div class="grid">
          <% mangaFolders.forEach(folder => { %>
            <div class="tile folder-tile" onclick="openFolder('<%= folder.path %>')">
              <strong class="file-name"><%= folder.name %></strong>
              <div class="file-count"><%= folder.fileCount %> Chapter(s)</div>
            </div>
          <% }) %>
        </div>
      </div>
    <% } %>

    <!-- Anime Section -->
    <% if (animeFolders.length > 0) { %>
      <div class="folders-section" style="margin-left: 15px; margin-top: 30px;">
        <h2 style="padding-top: 5px; padding-bottom: 5px;">Anime</h2>
        <div class="grid">
          <% animeFolders.forEach(folder => { %>
            <div class="tile folder-tile" onclick="openFolder('<%= folder.path %>')">
              <strong class="file-name"><%= folder.name %></strong>
              <div class="file-count"><%= folder.fileCount %> Episode(s)</div>
            </div>
          <% }) %>
        </div>
      </div>
    <% } %>

    <!-- Individual Files Section -->
    <% if (files.length > 0) { %>
      <% 
        var videoFiles = files.filter(function(f) { return f.type === '.webm'; });
        var novelFiles = files.filter(function(f) { return ['.txt', '.epub', '.pdf'].includes(f.type); });
        var mangaFiles = files.filter(function(f) { return ['.cbz', '.zip'].includes(f.type); });
        var imageFiles = files.filter(function(f) { return ['.jpg','.jpeg','.png','.gif'].includes(f.type); });
      %>
      
      <!-- Manga Chapters (if in a manga folder) -->
      <% if (mangaFiles.length > 0) { %>
        <div class="grid" style="margin-left: 10px;">
          <% mangaFiles.forEach(function(file) { %>
            <div class="tile" onclick="openFile('<%= file.path %>', '<%= file.type %>', '<%= file.name %>')">
              <div class="file-icon">
                <img src="data:image/png;base64,<%= faviconBase64 %>" class="file-icon-img" alt="Manga">
              </div>
              <strong class="file-name"><%= file.name %></strong>
            </div>
          <% }) %>
        </div>
      <% } %>
      
      <!-- Videos -->
      <% if (videoFiles.length > 0) { %>
        <h2 style="margin-left: 10px; margin-top: 30px;">Episodes</h2>
        <div class="grid" style="margin-left: 10px;">
          <% videoFiles.forEach(function(file) { %>
            <div class="tile" onclick="openFile('<%= file.path %>', '<%= file.type %>', '<%= file.name %>')">
              <div class="file-icon">üé¨</div>
              <strong class="file-name"><%= file.name %></strong>
            </div>
          <% }) %>
        </div>
      <% } %>
      
      <!-- Novels -->
      <% if (novelFiles.length > 0) { %>
        <h2 style="margin-left: 10px; margin-top: 30px;">Novels</h2>
        <div class="grid" style="margin-left: 10px;">
          <% novelFiles.forEach(function(file) { %>
            <div class="tile" onclick="openFile('<%= file.path %>', '<%= file.type %>', '<%= file.name %>')">
              <div class="file-icon">
                <% if (file.type === '.txt') { %>üìÑ
                <% } else if (file.type === '.epub') { %>
                  <img src="data:image/png;base64,<%= faviconBase64 %>" class="file-icon-img" alt="EPUB">
                <% } else if (file.type === '.pdf') { %>
                  <img src="data:image/png;base64,<%= faviconBase64 %>" class="file-icon-img" alt="PDF">
                <% } else { %>üìÑ<% } %>
              </div>
              <strong class="file-name"><%= file.name %></strong>
            </div>
          <% }) %>
        </div>
      <% } %>
      
      <!-- Images -->
      <% if (imageFiles.length > 0) { %>
        <h2 style="margin-left: 10px; margin-top: 30px;">Images</h2>
        <div class="grid" style="margin-left: 10px;">
          <% imageFiles.forEach(function(file) { %>
            <div class="tile" onclick="openFile('<%= file.path %>', '<%= file.type %>', '<%= file.name %>')">
              <div class="file-icon">üñºÔ∏è</div>
              <strong class="file-name"><%= file.name %></strong>
            </div>
          <% }) %>
        </div>
      <% } %>
    <% } %>

    <!-- Empty State -->
    <% if (mangaFolders.length === 0 && animeFolders.length === 0 && files.length === 0) { %>
      <div class="empty-message">
        This folder is empty
        <br><br>
        <a href="/library">‚Üê Back to Library</a>
      </div>
    <% } %>

    <!-- File Content Viewer (for text only) -->
    <div id="fileContent" style="margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; min-height: 100px; display: none;">
      Click a text file to preview its content.
    </div>
  </div>

  <script>
    function openFolder(folderPath) {
      window.location.href = `/library?folder=${encodeURIComponent(folderPath)}`;
    }

    function openFile(filePath, fileType, fileName) {
      if (fileType === '.txt') {
        document.getElementById('fileContent').style.display = 'block';
        loadTextFile(filePath);
      } else if (['.cbz', '.zip'].includes(fileType)) {
        const readerUrl = `/reader?file=${encodeURIComponent(filePath)}&name=${encodeURIComponent(fileName)}`;
        window.location.href = readerUrl;
      } else if (fileType === '.webm') {
        window.location.href = '/watcher?file=' + encodeURIComponent(filePath) + '&name=' + encodeURIComponent(fileName);
      } else {
        window.open('/file/' + encodeURIComponent(filePath), '_blank');
      }
    }

    async function loadTextFile(filePath) {
      const contentDiv = document.getElementById('fileContent');
      
      try {
        contentDiv.innerHTML = '<div style="text-align: center; color: #666;">Loading...</div>';
        
        const res = await fetch('/file/' + encodeURIComponent(filePath));
        if (!res.ok) throw new Error('Failed to load file');
        
        const text = await res.text();
        contentDiv.innerHTML = `
          <div style="margin-bottom: 10px;">
            <strong>Text File Preview:</strong>
            <button onclick="document.getElementById('fileContent').style.display='none'" style="float: right; background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Close</button>
          </div>
          <pre style="white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto; background: white; padding: 15px; border-radius: 5px;">${escapeHtml(text)}</pre>
        `;
      } catch (err) {
        contentDiv.innerHTML = `
          <div style="margin-bottom: 10px;">
            <strong>Error:</strong>
            <button onclick="document.getElementById('fileContent').style.display='none'" style="float: right; background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Close</button>
          </div>
          <div style="color: #d32f2f;">Failed to load file: ${escapeHtml(err.message)}</div>
        `;
        console.error(err);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const textViewer = document.getElementById('fileContent');
        if (textViewer.style.display !== 'none') {
          textViewer.style.display = 'none';
        }
      }
    });
  </script>
  <div class="version-id"><%= version %></div>
</body>
</html>